<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>3D model web-based showcase</title>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>
    <style>
      /* Keeping your original sleek styling */
      @import url("https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,700&family=Space+Grotesk:wght@400;500;600&display=swap");

      :root {
        color-scheme: light;
        --ink-900: #0b1420; --ink-700: #1c2c3a; --ink-600: #2b4256; --ink-500: #41586e;
        --sand-50: #f7f2e9; --sand-100: #efe6d8; --sea-500: #0c9fa0; --sea-700: #0a6f73;
        --glass: rgba(255, 255, 255, 0.82); --glass-strong: rgba(255, 255, 255, 0.92);
        --stroke: rgba(14, 23, 38, 0.12); --shadow: 0 22px 50px rgba(11, 20, 32, 0.16);
        --radius-lg: 24px; --radius-md: 16px; --radius-sm: 12px;
      }

      * { box-sizing: border-box; }
      body {
        margin: 0; min-height: 100vh; font-family: "Space Grotesk", sans-serif; color: var(--ink-900);
        background: radial-gradient(1200px 600px at 15% -10%, rgba(12, 159, 160, 0.2), transparent 60%),
                    linear-gradient(130deg, #f7f2e9 0%, #eef2f6 58%, #eef2eb 100%);
      }

      .page { max-width: 1200px; margin: 0 auto; padding: 32px 20px 60px; }
      .hero { display: grid; gap: 18px; padding: 32px; background: var(--glass-strong); border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--stroke); }
      .hero h1 { font-family: "Fraunces", serif; font-size: clamp(2.2rem, 3vw, 3.3rem); margin: 0; }
      
      .viewer-section { display: grid; grid-template-columns: minmax(240px, 320px) minmax(0, 1fr); gap: 26px; margin-top: 28px; }
      .panel { background: var(--glass); border-radius: var(--radius-lg); padding: 22px; border: 1px solid var(--stroke); }
      
      .model-list { display: grid; gap: 12px; margin-top: 16px; }
      .model-button { display: grid; gap: 4px; padding: 14px; border-radius: var(--radius-md); border: 1px solid transparent; background: rgba(255, 255, 255, 0.7); cursor: pointer; text-align: left; }
      .model-button[data-active="true"] { border-color: var(--sea-700); background: rgba(12, 159, 160, 0.08); }

      .viewer-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 15px; }
      .control-chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 999px; background: #fff; border: 1px solid var(--stroke); font-size: 0.85rem; }
      
      .viewer-stage { position: relative; border-radius: var(--radius-lg); overflow: hidden; border: 1px solid var(--stroke); height: 460px; background: #fff; }
      #modelCanvas { width: 100%; height: 100%; }

      .tag { padding: 4px 10px; border-radius: 999px; font-size: 0.7rem; background: rgba(12, 159, 160, 0.1); border: 1px solid var(--sea-500); }
      @media (max-width: 900px) { .viewer-section { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <h1>Bridging Data Complexity in Geosciences</h1>
        <p>Interactive 3D library for AGU 2025. Explore scientific assets with specialized shading.</p>
      </header>

      <section class="viewer-section">
        <aside class="panel">
          <h2>Model library</h2>
          <div class="model-list" id="modelList"></div>
        </aside>

        <div class="panel">
          <div class="viewer-controls">
            <label class="control-chip">
              Shading
              <select id="colormapSelect">
                <option value="original">Original Materials</option>
                <option value="chromadepth">ChromaDepth (3D Glasses)</option>
                <option value="wireframe">Wireframe</option>
              </select>
            </label>
            <label class="control-chip">
              Depth Contrast
              <input type="range" id="depthContrast" min="0.1" max="2.0" step="0.1" value="1.0">
            </label>
            <label class="control-chip"><input type="checkbox" id="autoRotate" checked> Auto-rotate</label>
            <button class="control-chip" id="resetView">Reset View</button>
          </div>

          <div class="viewer-stage">
            <canvas id="modelCanvas"></canvas>
          </div>

          <div style="margin-top:20px">
            <h2 id="modelTitle">Select a model</h2>
            <p id="modelDescription">Context will appear here.</p>
            <div id="modelTags" style="display:flex; gap:5px;"></div>
          </div>
        </div>
      </section>
    </div>

    <script type="module">
      import * as THREE from "three";
      import { OrbitControls } from "three/examples/jsm/controls/OrbitControls.js";
      import { GLTFLoader } from "three/examples/jsm/loaders/GLTFLoader.js";
      import { PLYLoader } from "three/examples/jsm/loaders/PLYLoader.js";

      // --- RESTORED ORIGINAL MODEL DATA ---
      const modelData = [
        { id: "interior", name: "Earth interior cutaway", subtitle: "Four-layer interior", file: "Assets/earths_interior.opt.glb", useCase: "STEM outreach", tags: ["Geology", "Education"] },
        { id: "antarctica", name: "Antarctica topography", subtitle: "3D-print-ready relief", file: "Assets/Antarctica3.opt.glb", useCase: "Polar research", tags: ["Cryosphere", "Elevation"] },
        { id: "cubesat", name: "CubeSat 1U platform", subtitle: "Reference geometry", file: "Assets/CubeSat_-_1_RU_Generic.opt.glb", useCase: "Engineering", tags: ["Spacecraft"] },
        { id: "iss", name: "International Space Station", subtitle: "NASA orbital lab", file: "Assets/ISS_stationary.opt.glb", useCase: "Mission storytelling", tags: ["Spacecraft", "ISS"] },
        { id: "awe", name: "AWE swath over CONUS", subtitle: "Gravity wave capture", file: "Assets/AWE_radiance.opt.glb", useCase: "Instrument explainer", tags: ["Atmosphere", "AWE"] },
        { id: "tohoku", name: "Tohoku 2011 system", subtitle: "Seismic event volume", file: "Assets/tohoku.opt.glb", useCase: "Hazard communication", tags: ["Seismic", "Hazards"] },
        { id: "coral", name: "Curacao Snake Bay reef", subtitle: "20m reef segment", file: "Assets/coral_reef.opt.glb", useCase: "Biodiversity", tags: ["Ocean", "Ecology"] }
      ];

      let scene, camera, renderer, controls, currentModel;
      const canvas = document.getElementById("modelCanvas");
      const gltfLoader = new GLTFLoader();

      // --- CHROMADEPTH SHADER (FIXED: Red=Near, Blue=Far) ---
      const chromaMaterial = new THREE.ShaderMaterial({
        uniforms: { uNear: { value: 0 }, uFar: { value: 10 }, uContrast: { value: 1.0 } },
        vertexShader: `
          varying float vDepth;
          void main() {
            vec4 viewPos = modelViewMatrix * vec4(position, 1.0);
            vDepth = -viewPos.z;
            gl_Position = projectionMatrix * viewPos;
          }
        `,
        fragmentShader: `
          uniform float uNear; uniform float uFar; uniform float uContrast;
          varying float vDepth;
          vec3 hue2rgb(float h) {
            float r = abs(h * 6.0 - 3.0) - 1.0;
            float g = 2.0 - abs(h * 6.0 - 2.0);
            float b = 2.0 - abs(h * 6.0 - 4.0);
            return clamp(vec3(r, g, b), 0.0, 1.0);
          }
          void main() {
            float d = clamp((vDepth - uNear) / (uFar - uNear), 0.0, 1.0);
            d = pow(d, uContrast); // Adjust contrast curve
            vec3 color = hue2rgb(d * 0.66); // 0.0=Red (Near), 0.66=Blue (Far)
            gl_FragColor = vec4(color, 1.0);
          }
        `
      });

      function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(2, 2, 5);

        renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);

        controls = new OrbitControls(camera, renderer.domElement);
        
        scene.add(new THREE.AmbientLight(0xffffff, 1));
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        buildList();
        loadModel(modelData[0]);
        animate();
      }

      function buildList() {
        const list = document.getElementById("modelList");
        modelData.forEach(m => {
          const btn = document.createElement("button");
          btn.className = "model-button";
          btn.innerHTML = `<strong>${m.name}</strong><span style="font-size:0.8rem">${m.subtitle}</span>`;
          btn.onclick = () => loadModel(m);
          list.appendChild(btn);
        });
      }

      function loadModel(data) {
        if (currentModel) scene.remove(currentModel);
        
        gltfLoader.load(data.file, (gltf) => {
          currentModel = gltf.scene;
          
          // Auto-center
          const box = new THREE.Box3().setFromObject(currentModel);
          const center = box.getCenter(new THREE.Vector3());
          currentModel.position.sub(center);
          
          scene.add(currentModel);
          updateInfo(data);
          applyShading();
        });
      }

      function applyShading() {
        if (!currentModel) return;
        const mode = document.getElementById("colormapSelect").value;
        const contrast = document.getElementById("depthContrast").value;

        currentModel.traverse(n => {
          if (n.isMesh) {
            if (mode === "chromadepth") {
              const box = new THREE.Box3().setFromObject(currentModel);
              const dist = camera.position.length();
              const size = box.getSize(new THREE.Vector3()).length();
              
              chromaMaterial.uniforms.uNear.value = dist - (size / 2);
              chromaMaterial.uniforms.uFar.value = dist + (size / 2);
              chromaMaterial.uniforms.uContrast.value = contrast;
              n.material = chromaMaterial;
            } else if (mode === "wireframe") {
              n.material = new THREE.MeshBasicMaterial({ color: 0x0c9fa0, wireframe: true });
            } else {
              // Revert to GLB's original material
              n.material = n.userData.originalMat || n.material;
            }
          }
        });
      }

      function updateInfo(data) {
        document.getElementById("modelTitle").innerText = data.name;
        document.getElementById("modelDescription").innerText = data.useCase;
        const tags = document.getElementById("modelTags");
        tags.innerHTML = "";
        data.tags.forEach(t => {
          const s = document.createElement("span"); s.className = "tag"; s.innerText = t;
          tags.appendChild(s);
        });
      }

      function animate() {
        requestAnimationFrame(animate);
        controls.autoRotate = document.getElementById("autoRotate").checked;
        controls.update();
        if (document.getElementById("colormapSelect").value === "chromadepth") applyShading();
        renderer.render(scene, camera);
      }

      window.addEventListener('resize', () => {
        camera.aspect = canvas.clientWidth / canvas.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      });

      document.getElementById("colormapSelect").onchange = applyShading;
      document.getElementById("depthContrast").oninput = applyShading;
      document.getElementById("resetView").onclick = () => { camera.position.set(2,2,5); controls.target.set(0,0,0); };

      init();
    </script>
  </body>
</html>
